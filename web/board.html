<HTML><HEAD>
<!-- vim:set ts=4 sw=4: -->
<!-- $Id$ -->
<TITLE></TITLE>
<LINK REV="made" HREF="mailto:sec@42.org">
<STYLE TYPE="text/css" MEDIA="screen">

.ui > * {
	display: none;
	position: absolute;
}

#reconnect {
	opacity:		0.8;
	top:			0;
	right:			0;
	text-align:		center;
	background-color: #e22;
	z-index:		10000;
}

#buzzer {
	opacity:		0.8;
	bottom:			0;
	right:			0;
	text-align:		center;
	background-color: #aaa;
	z-index:		100;
}

#bplayer {
width: 100%;
}

#qmask {
	opacity:    	0.9;
	top:			0;
	left:			0;
	width:			100%;
	height:			100%;
	text-align:		center;
	background-color: #eef;
	z-index:		10;
}
#question {
	display:		table-cell;
	vertical-align:	middle;
	align:			center;
	font-size:		60px;
}

#noscript {
	display:		block;
	opacity:		0.8;
	top:			0;
	left:			0;
	width:			85%;
	font-size:		x-large;
	text-align:		center;
	margin:			1% 5%;
	padding:		20px;
	border:			2px solid black;
	background-color: #c33;
}


</STYLE>
</HEAD>
<BODY>
<script type="text/javascript" src="jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.8.11.custom.min.js"></script>

<div class="ui">
<h1>All the UI elements go here:</h1>
<div id="reconnect">Disconnected</div>
<div id="noscript">Javascript needs to be enabled. Sorry. :-(</div>
<div id="buzzer">
	<div id="bplayer">Nobody</div>
	<div id="bbutton">
		<button id="bright">Right</button>
		<button id="bwrong">Wrong</button>
		<button id="boops" >Oops</button>
	</div>
</div>
<div id="qmask"><div id="question">text comes here</div></div>
</div>

<div id=canvas><!-- Stuff goes here --></div>

<script type = "text/javascript">
$("#noscript").hide(); // Check if javascript (and jquery) work.

function initui(){
// Right/Wrong/Oops widget after buzzering
	$("#bright").keydown( function(ev){
			if(ev.keyCode==39){
				$("#bwrong").focus();
			}else if (ev.keyCode==37){
				$("#boops").focus();
			};
			});
	$("#bwrong").keydown( function(ev){
			if(ev.keyCode==39){
				$("#boops").focus();
			}else if (ev.keyCode==37){
				$("#bright").focus();
			};
			});
	$("#boops").keydown( function(ev){
			if(ev.keyCode==39){
				$("#bright").focus();
			}else if (ev.keyCode==37){
				$("#bwrong").focus();
			};
			});
	$("#bright").click( function(){
			$("#out").html("clicked right");
			announce({answer: "right"});
			$("#buzzer").hide();
			});
	$("#bwrong").click( function(){
			$("#out").html("clicked wrong");
			announce({answer: "wrong"});
			$("#buzzer").hide();
			});
	$("#boops").click( function(){
			$("#out").html("clicked oops");
			announce({answer: "oops"});
			$("#buzzer").hide();
			});
};

var ws;
// Create a table (CxP)

function question(qid) {
//	alert("qid:"+qid);
	ws.send("question "+qid);
}

function announce(event){
	ws.send( JSON.stringify(event));
};

function mkBoard(boarddef,cats,players){
	var nocats=5; // No. of categories
	var nopts=5;  // No. of points

	function clearNode(node){
		while (node.hasChildNodes()){
			node.removeChild(node.firstChild);
		};
	};

	var canvas= document.getElementById('canvas');
	if(!canvas)
		throw("<div id=canvas> missing from HTML file.");
	clearNode(canvas);
	var object=document.createElement("div");
	object.id="board";
	canvas.appendChild(object);

	var board=new Array;

	for (var x = 0; x < nocats; x++) {
		var btn=document.createElement("div");
		btn.style.border="solid 1px black";
		btn.style.float="left";
		btn.style.width="19%";
//		btn.style.height="9%";
		btn.innerHTML=cats[x]; //"Cat "+(x+1);
		object.appendChild(btn);
	};
	for (var y = 0; y < nopts; y++) {
	  for (var x = 0; x < nocats; x++) {
			var btn=document.createElement("div");
			btn.style.border="solid 1px black";
			btn.style.float="left";
			btn.style.width="19%";
			btn.style.height="9%";
			btn.innerHTML=boarddef[x][y].score;
		$(btn).bind("click",{x:x, y:y},function (evt){question(boarddef[evt.data.x][evt.data.y].qid)});
			object.appendChild(btn);
			if(y==0) board[x]=new Array();
			board[x][y]=btn;
	  };
	};
	for (var x = 0 ; x<3; x++){
			var btn=document.createElement("div");
			btn.style.border="solid 1px black";
			btn.style.float="left";
			btn.style.width="32%";
			btn.style.height="9%";
			btn.innerHTML="Ply"+x+players; //players[x];
			object.appendChild(btn);
	};

	var end=document.createElement("br");
	end.style.clear="both";
	object.appendChild(end);
}
</script>

<script type = "text/javascript">

$(document).ready(function(){


if ("WebSocket" in window) {
	debug("Horray you have web sockets");
	start();
} else {
	alert("You have no web sockets");
};


function start(){
	debug("Trying to connect...");
	ws = new WebSocket("ws://ice.42.org:8090/websession");

	ws.onopen = function() {
	// Web Socket is connected. You can send data by send() method.
	debug("connected...");
	ws.send("board");
	};

	initui();

	run = function() {
		var val=$("#i1").val(); // read the entry
		$("#i1").val("");       // and clear it
		ws.send(val);
		return true;            // must do this
	};

	ws.onmessage = function (evt) {
		var data = evt.data;
		if(data.slice(0,1)=="{"){
			var result=JSON.parse(data);
			if (result.board){
				$("#out").html("Its a board");
				mkBoard(result.board,result.categories,result.players);
			}else if(result.question){
				$("#out").html("Qstart");
				var mask=$("#qmask");
				// this has to be replaced with something better, later on
				$(mask).bind("click",function(){$(mask).hide()});

				q=$("#question");
				if(result.question.type == "image"){ // maybe preloading?
					$(q).html("<img src="+result.question.url+">");
				}else{
					$(q).html(result.question.text);
				};
				$(mask).css("display","table"); // instead of .show()
				$("#out").html("Qend");
			}else if(result.buzzer){
				$("#out").html("Buzzer");
				$("#buzzer").show();
				$("#bright").focus();
			}else{
				$("#out").html(JSON.stringify(result));
			}
		}else{
			$("#out").html("non-JSON received. See debug log.");
			debug("[dbg] "+data);
		};
	};

	ws.onclose = function() {
		debug(" socket closed");
		$("#reconnect")
				.bind("click",function(){
					start();
					$("#reconnect").hide();
					});
		$("#reconnect").show();
	};

};

function debug(str){
	$("#debug").append("<p>" +  str);
};


});



</script>
<h2>In:</h2>
<input id="i1" onchange="run()" size ="42">
<h2>Out:</h2>
<div id="out">Output should appear here</div>
<h2>Debug:</h2>
<div id="debug"></div>
<HR>
<!-- ADD -->
</BODY>
</HTML>
